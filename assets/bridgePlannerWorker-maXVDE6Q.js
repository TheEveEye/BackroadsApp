(function(){"use strict";let M=null,S=[];function N(t){const e=typeof t.security=="number"?t.security:null;return t.regionId===10000070||e!=null&&e>=.5}function L(t){const e=[];for(const[r,n]of Object.entries(t.systems)){const i=Number(r);Number.isFinite(i)&&e.push({id:i,x:n.position.x,y:n.position.y,z:n.position.z,regionId:n.regionId,security:Number.isFinite(n.security)?Number(n.security):null,adjacentSystems:n.adjacentSystems||[]})}S=e}function j(t,e,r){var b;const n=new Map,i=new Map;if(!M)return{dist:n,prev:i};const m=M.systems,u=m[String(t)];if(!u)return{dist:n,prev:i};const l=new Set;e.excludeZarzakh&&l.add(301e5);const I=!!e.sameRegionOnly,x=u.regionId,p=new Map;if(e.allowAnsiblex&&((b=e.ansiblexes)!=null&&b.length))for(const f of e.ansiblexes){if(!f||f.enabled===!1)continue;const o=Number(f.from),c=Number(f.to);!Number.isFinite(o)||!Number.isFinite(c)||(p.has(o)||p.set(o,[]),p.get(o).push(c),f.bidirectional!==!1&&(p.has(c)||p.set(c,[]),p.get(c).push(o)))}n.set(t,0);const h=[t];for(let f=0;f<h.length;f++){const o=h[f],c=n.get(o);if(c==null||c>=r)continue;const y=m[String(o)];if(y&&!l.has(o)&&!(I&&y.regionId!==x)){for(const a of y.adjacentSystems){if(l.has(a))continue;const s=m[String(a)];s&&(I&&s.regionId!==x||n.has(a)||(n.set(a,c+1),i.set(a,o),h.push(a)))}if(e.allowAnsiblex){const a=p.get(o)||[];for(const s of a){if(l.has(s))continue;const d=m[String(s)];d&&(I&&d.regionId!==x||n.has(s)||(n.set(s,c+1),i.set(s,o),h.push(s)))}}}}return{dist:n,prev:i}}function v(t,e,r){const n=[];let i=r;for(;i!=null&&(n.push(i),i!==e);)if(i=t.get(i),i==null)return null;return n.reverse()}function _(t,e){return t.totalJumps!==e.totalJumps?t.totalJumps-e.totalJumps:t.stagingJumps!==e.stagingJumps?t.stagingJumps-e.stagingJumps:t.destinationJumps!==e.destinationJumps?t.destinationJumps-e.destinationJumps:t.bridgeMeters-e.bridgeMeters}function F(t,e,r){const n=t.findIndex(i=>_(e,i)<0);return n===-1?t.length<r?(t.push(e),!0):!1:(t.splice(n,0,e),t.length>r&&t.pop(),!0)}function P(t,e,r,n,i){const m=[];for(const u of t){const l=v(e,n,u.parkingId),I=v(r,i,u.endpointId);!l||!I||m.push({key:`${u.parkingId}-${u.endpointId}`,travelPath:l,postBridgePath:I.slice().reverse(),parkingId:u.parkingId,bridgeEndpointId:u.endpointId,travelJumps:u.stagingJumps,postBridgeJumps:u.destinationJumps,totalJumps:u.totalJumps,bridgeLy:u.bridgeMeters/94607e11})}return m}function q(t,e){if(!M)return{routes:[],message:"Graph not loaded.",baselineJumps:null};const r=M.systems,n=r[String(t.destinationId)],i=r[String(t.stagingId)];if(!n)return{routes:[],message:"Destination system not found.",baselineJumps:null};if(!i)return{routes:[],message:"Staging system not found.",baselineJumps:null};if(N(n))return{routes:[],message:"Destination is in highsec or Pochven.",baselineJumps:null};if(t.settings.bridgeFromStaging&&N(i))return{routes:[],message:"Starting system is in highsec or Pochven.",baselineJumps:null};const m=t.bridgeRange*94607e11,u=m*m,{dist:l,prev:I}=j(t.stagingId,t.settings,200),{dist:x,prev:p}=j(t.destinationId,t.settings,200),h=l.get(t.destinationId)??null,b=[];if(t.settings.bridgeIntoDestination){const s=x.get(t.destinationId);s!=null&&b.push({id:t.destinationId,x:n.position.x,y:n.position.y,z:n.position.z,jumps:s})}else for(const s of S){const d=x.get(s.id);d!=null&&b.push({id:s.id,x:s.x,y:s.y,z:s.z,jumps:d})}if(b.length===0)return{routes:[],message:"No destination routes found.",baselineJumps:h};const f=Math.max(1,Math.min(25,t.routesToShow||5)),o=[];let c=0;const y=(s=!1)=>{if(!e)return;const d=typeof performance<"u"?performance.now():Date.now();if(!s&&d-c<80)return;c=d;const g=P(o,I,p,t.stagingId,t.destinationId);e(g,h)};for(const s of S){if(t.settings.bridgeFromStaging&&s.id!==t.stagingId||t.settings.excludeZarzakh&&s.id===301e5||N(s))continue;const d=l.get(s.id);if(d==null)continue;let g=null;for(const J of b){const k=s.x-J.x,w=s.y-J.y,z=s.z-J.z,R=k*k+w*w+z*z;if(R>u)continue;const E=Math.sqrt(R);(!g||J.jumps<g.jumps||J.jumps===g.jumps&&E<g.bridgeMeters)&&(g={id:J.id,jumps:J.jumps,bridgeMeters:E})}if(!g)continue;const A=d+g.jumps,D={parkingId:s.id,endpointId:g.id,stagingJumps:d,destinationJumps:g.jumps,bridgeMeters:g.bridgeMeters,totalJumps:A};F(o,D,f)&&y(o.length===1)}if(o.length===0)return{routes:[],message:"No reachable parking systems found.",baselineJumps:h};const a=P(o,I,p,t.stagingId,t.destinationId);return a.length===0?{routes:[],message:"No routes found.",baselineJumps:h}:{routes:a,message:null,baselineJumps:h}}self.onmessage=t=>{const e=t.data;if(e.type==="init"){M=e.graph,L(e.graph);return}if(e.type==="compute"){const r=q(e,(n,i)=>{self.postMessage({type:"partial",requestId:e.requestId,routes:n,message:null,baselineJumps:i})});self.postMessage({type:"result",requestId:e.requestId,...r})}}})();
