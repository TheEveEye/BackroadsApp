(function(){"use strict";let b=null,x=[];function N(s){const i=[];for(const[g,o]of Object.entries(s.systems)){const r=Number(g);Number.isFinite(r)&&i.push({id:r,x:o.position.x,y:o.position.y,z:o.position.z,regionId:o.regionId,adjacentSystems:o.adjacentSystems||[]})}x=i}function y(s,i,g){var t;const o=new Map,r=new Map;if(!b)return{dist:o,prev:r};const h=b.systems,M=h[String(s)];if(!M)return{dist:o,prev:r};const J=new Set;i.excludeZarzakh&&J.add(301e5);const l=!!i.sameRegionOnly,m=M.regionId,f=new Map;if(i.allowAnsiblex&&((t=i.ansiblexes)!=null&&t.length))for(const e of i.ansiblexes){if(!e||e.enabled===!1)continue;const n=Number(e.from),u=Number(e.to);!Number.isFinite(n)||!Number.isFinite(u)||(f.has(n)||f.set(n,[]),f.get(n).push(u),e.bidirectional!==!1&&(f.has(u)||f.set(u,[]),f.get(u).push(n)))}o.set(s,0);const p=[s];for(let e=0;e<p.length;e++){const n=p[e],u=o.get(n);if(u==null||u>=g)continue;const d=h[String(n)];if(d&&!J.has(n)&&!(l&&d.regionId!==m)){for(const a of d.adjacentSystems){if(J.has(a))continue;const c=h[String(a)];c&&(l&&c.regionId!==m||o.has(a)||(o.set(a,u+1),r.set(a,n),p.push(a)))}if(i.allowAnsiblex){const a=f.get(n)||[];for(const c of a){if(J.has(c))continue;const I=h[String(c)];I&&(l&&I.regionId!==m||o.has(c)||(o.set(c,u+1),r.set(c,n),p.push(c)))}}}}return{dist:o,prev:r}}function S(s,i,g){const o=[];let r=g;for(;r!=null&&(o.push(r),r!==i);)if(r=s.get(r),r==null)return null;return o.reverse()}function v(s){if(!b)return{routes:[],message:"Graph not loaded."};const i=b.systems;if(!i[String(s.destinationId)])return{routes:[],message:"Destination system not found."};if(!i[String(s.stagingId)])return{routes:[],message:"Staging system not found."};const g=s.bridgeRange*94607e11,o=g*g,{dist:r,prev:h}=y(s.stagingId,s.settings,200),{dist:M,prev:J}=y(s.destinationId,s.settings,200),l=[];for(const t of x){const e=M.get(t.id);e!=null&&l.push({id:t.id,x:t.x,y:t.y,z:t.z,jumps:e})}if(l.length===0)return{routes:[],message:"No destination routes found."};const m=[];for(const t of x){if(s.settings.excludeZarzakh&&t.id===301e5)continue;const e=r.get(t.id);if(e==null)continue;let n=null;for(const d of l){const a=t.x-d.x,c=t.y-d.y,I=t.z-d.z,j=a*a+c*c+I*I;if(j>o)continue;const k=Math.sqrt(j);(!n||d.jumps<n.jumps||d.jumps===n.jumps&&k<n.bridgeMeters)&&(n={id:d.id,jumps:d.jumps,bridgeMeters:k})}if(!n)continue;const u=e+n.jumps;m.push({parkingId:t.id,endpointId:n.id,stagingJumps:e,destinationJumps:n.jumps,bridgeMeters:n.bridgeMeters,totalJumps:u})}if(m.length===0)return{routes:[],message:"No reachable parking systems found."};m.sort((t,e)=>t.totalJumps!==e.totalJumps?t.totalJumps-e.totalJumps:t.stagingJumps!==e.stagingJumps?t.stagingJumps-e.stagingJumps:t.destinationJumps!==e.destinationJumps?t.destinationJumps-e.destinationJumps:t.bridgeMeters-e.bridgeMeters);const f=Math.max(1,Math.min(25,s.routesToShow||5)),p=[];for(const t of m.slice(0,f)){const e=S(h,s.stagingId,t.parkingId),n=S(J,s.destinationId,t.endpointId);!e||!n||p.push({key:`${t.parkingId}-${t.endpointId}`,travelPath:e,postBridgePath:n.slice().reverse(),parkingId:t.parkingId,bridgeEndpointId:t.endpointId,travelJumps:t.stagingJumps,postBridgeJumps:t.destinationJumps,totalJumps:t.totalJumps,bridgeLy:t.bridgeMeters/94607e11})}return p.length===0?{routes:[],message:"No routes found."}:{routes:p,message:null}}self.onmessage=s=>{const i=s.data;if(i.type==="init"){b=i.graph,N(i.graph);return}if(i.type==="compute"){const g=v(i);self.postMessage({type:"result",requestId:i.requestId,...g})}}})();
