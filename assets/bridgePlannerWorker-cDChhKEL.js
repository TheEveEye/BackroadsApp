var lt=Object.defineProperty;var pt=(y,v,P)=>v in y?lt(y,v,{enumerable:!0,configurable:!0,writable:!0,value:P}):y[v]=P;var nt=(y,v,P)=>pt(y,typeof v!="symbol"?v+"":v,P);(function(){"use strict";let z=null,j=[];function T(t){const n=typeof t.security=="number"?t.security:null;return t.regionId===10000070||n!=null&&n>=.5}function et(t){const n=[];for(const[u,e]of Object.entries(t.systems)){const i=Number(u);Number.isFinite(i)&&n.push({id:i,x:e.position.x,y:e.position.y,z:e.position.z,regionId:e.regionId,security:Number.isFinite(e.security)?Number(e.security):null,adjacentSystems:e.adjacentSystems||[]})}j=n}function V(t){var u;const n=new Map;if(t.allowAnsiblex&&((u=t.ansiblexes)!=null&&u.length))for(const e of t.ansiblexes){if(!e||e.enabled===!1)continue;const i=Number(e.from),o=Number(e.to);!Number.isFinite(i)||!Number.isFinite(o)||(n.has(i)||n.set(i,[]),n.get(i).push(o),e.bidirectional!==!1&&(n.has(o)||n.set(o,[]),n.get(o).push(i)))}return n}function U(t){var u;const n=new Set;if(!t.blacklistEnabled||!((u=t.blacklist)!=null&&u.length))return n;for(const e of t.blacklist){if(!e||e.enabled===!1)continue;const i=Number(e.id);Number.isFinite(i)&&n.add(i)}return n}function Y(t,n,u){const e=new Map,i=new Map;if(!z)return{dist:e,prev:i};const o=z.systems,p=o[String(t)];if(!p)return{dist:e,prev:i};const d=new Set;n.excludeZarzakh&&d.add(301e5);const s=U(n),a=!!n.sameRegionOnly,m=p.regionId,f=V(n);e.set(t,0);const l=[t];for(let h=0;h<l.length;h++){const J=l[h],S=e.get(J);if(S==null||S>=u)continue;const E=o[String(J)];if(E&&!(d.has(J)||s.has(J))&&!(a&&E.regionId!==m)){for(const x of E.adjacentSystems){if(d.has(x)||s.has(x))continue;const w=o[String(x)];w&&(a&&w.regionId!==m||e.has(x)||(e.set(x,S+1),i.set(x,J),l.push(x)))}if(n.allowAnsiblex){const x=f.get(J)||[];for(const w of x){if(d.has(w)||s.has(w))continue;const F=o[String(w)];F&&(a&&F.regionId!==m||e.has(w)||(e.set(w,S+1),i.set(w,J),l.push(w)))}}}}return{dist:e,prev:i}}function _(t,n,u){const e=[];let i=u;for(;i!=null&&(e.push(i),i!==n);)if(i=t.get(i),i==null)return null;return e.reverse()}class st{constructor(){nt(this,"data",[])}push(n){this.data.push(n),this.bubbleUp(this.data.length-1)}pop(){if(this.data.length===0)return;const n=this.data[0],u=this.data.pop();return this.data.length>0&&(this.data[0]=u,this.bubbleDown(0)),n}get size(){return this.data.length}bubbleUp(n){for(;n>0;){const u=Math.floor((n-1)/2);if(this.data[u].cost<=this.data[n].cost)break;[this.data[u],this.data[n]]=[this.data[n],this.data[u]],n=u}}bubbleDown(n){const u=this.data.length;for(;;){let e=n;const i=n*2+1,o=n*2+2;if(i<u&&this.data[i].cost<this.data[e].cost&&(e=i),o<u&&this.data[o].cost<this.data[e].cost&&(e=o),e===n)break;[this.data[e],this.data[n]]=[this.data[n],this.data[e]],n=e}}}function it(t,n,u){const e=[];let i=n;for(;i!=null&&(e.push(i),i!==u);)if(i=t.get(i),i==null)return null;return e}function L(t,n){for(const u of t)if(n.has(u))return!0;return!1}function ot(t,n){return t.totalJumps!==n.totalJumps?t.totalJumps-n.totalJumps:t.stagingJumps!==n.stagingJumps?t.stagingJumps-n.stagingJumps:t.destinationJumps!==n.destinationJumps?t.destinationJumps-n.destinationJumps:t.bridgeMeters-n.bridgeMeters}function rt(t,n){return t.totalJumps!==n.totalJumps?t.totalJumps-n.totalJumps:t.stagingJumps!==n.stagingJumps?t.stagingJumps-n.stagingJumps:t.midTravelJumps!==n.midTravelJumps?t.midTravelJumps-n.midTravelJumps:t.destinationJumps!==n.destinationJumps?t.destinationJumps-n.destinationJumps:t.bridgeMeters!==n.bridgeMeters?t.bridgeMeters-n.bridgeMeters:t.bridge2Meters-n.bridge2Meters}function H(t,n,u,e){const i=t.findIndex(o=>e(n,o)<0);return i===-1?t.length<u?(t.push(n),!0):!1:(t.splice(i,0,n),t.length>u&&t.pop(),!0)}function G(t,n,u,e,i,o){const p=[];for(const d of t){const s=_(n,e,d.parkingId),a=_(u,i,d.endpointId);!s||!a||o&&(L(s,o)||L(a,o))||p.push({key:`${d.parkingId}-${d.endpointId}`,travelPath:s,postBridgePath:a.slice().reverse(),parkingId:d.parkingId,bridgeEndpointId:d.endpointId,travelJumps:d.stagingJumps,postBridgeJumps:d.destinationJumps,totalJumps:d.totalJumps,bridgeLy:d.bridgeMeters/94607e11})}return p}function X(t,n,u,e,i,o,p){const d=[];for(const s of t){const a=_(n,i,s.parkingId),m=it(e,s.endpointId,s.parking2Id),f=_(u,o,s.endpoint2Id);!a||!m||!f||p&&(L(a,p)||L(m,p)||L(f,p))||d.push({key:`${s.parkingId}-${s.endpointId}-${s.parking2Id}-${s.endpoint2Id}`,travelPath:a,midTravelPath:m,postBridgePath:f.slice().reverse(),parkingId:s.parkingId,bridgeEndpointId:s.endpointId,parking2Id:s.parking2Id,bridgeEndpoint2Id:s.endpoint2Id,travelJumps:s.stagingJumps,midTravelJumps:s.midTravelJumps,postBridgeJumps:s.destinationJumps,totalJumps:s.totalJumps,bridgeLy:s.bridgeMeters/94607e11,bridge2Ly:s.bridge2Meters/94607e11})}return d}function ut(t){if(!z)return new Map;const n=V(t),u=z.systems,e=new Map,i=!!t.sameRegionOnly,o=U(t);for(const[p,d]of Object.entries(u)){const s=Number(p);if(!Number.isFinite(s)||t.excludeZarzakh&&s===301e5||o.has(s))continue;const a=[];for(const m of d.adjacentSystems||[]){if(t.excludeZarzakh&&m===301e5||o.has(m))continue;const f=u[String(m)];f&&(i&&f.regionId!==d.regionId||a.push(m))}if(t.allowAnsiblex){const m=n.get(s)||[];for(const f of m){if(t.excludeZarzakh&&f===301e5||o.has(f))continue;const l=u[String(f)];l&&(i&&l.regionId!==d.regionId||a.push(f))}}e.set(s,a)}return e}function dt(t,n){const u=ut(n),e=new Map,i=new Map,o=new Map,p=new Map,d=new st;for(const s of t){const a=e.get(s.parkingId);a!=null&&a<=s.baseCost||(e.set(s.parkingId,s.baseCost),o.set(s.parkingId,s.parkingId),p.set(s.parkingId,s.endpointId),d.push({id:s.parkingId,cost:s.baseCost}))}for(;d.size>0;){const s=d.pop();if(!s)break;const a=e.get(s.id);if(a==null||s.cost!==a)continue;const m=u.get(s.id)||[],f=o.get(s.id),l=p.get(s.id);if(!(f==null||l==null))for(const h of m){const J=a+1,S=e.get(h);(S==null||J<S||J===S&&(o.get(h)==null||f<o.get(h)))&&(e.set(h,J),i.set(h,s.id),o.set(h,f),p.set(h,l),d.push({id:h,cost:J}))}}return{dist:e,prev:i,sourceParking:o,sourceEndpoint:p}}function ct(t,n){if(!z)return{routes:[],message:"Graph not loaded.",baselineJumps:null};const u=z.systems,e=u[String(t.destinationId)],i=u[String(t.stagingId)];if(!e)return{routes:[],message:"Destination system not found.",baselineJumps:null};if(!i)return{routes:[],message:"Staging system not found.",baselineJumps:null};const o=U(t.settings);if(t.settings.blacklistEnabled&&o.has(t.destinationId))return{routes:[],message:"Destination system is blacklisted.",baselineJumps:null};if(t.settings.blacklistEnabled&&o.has(t.stagingId))return{routes:[],message:"Staging system is blacklisted.",baselineJumps:null};if(T(e))return{routes:[],message:"Destination is in highsec or Pochven.",baselineJumps:null};if(t.settings.bridgeFromStaging&&T(i))return{routes:[],message:"Starting system is in highsec or Pochven.",baselineJumps:null};const p=t.bridgeRange*94607e11,d=p*p,{dist:s,prev:a}=Y(t.stagingId,t.settings,200),{dist:m,prev:f}=Y(t.destinationId,t.settings,200),l=s.get(t.destinationId)??null,h=[];if(t.settings.bridgeIntoDestination){const r=m.get(t.destinationId);r!=null&&h.push({id:t.destinationId,x:e.position.x,y:e.position.y,z:e.position.z,jumps:r})}else for(const r of j){if(t.settings.blacklistEnabled&&o.has(r.id))continue;const c=m.get(r.id);c!=null&&h.push({id:r.id,x:r.x,y:r.y,z:r.z,jumps:c})}if(h.length===0)return{routes:[],message:"No destination routes found.",baselineJumps:l};const J=Math.max(1,Math.min(25,t.routesToShow||5));if(Math.max(1,Math.min(2,t.settings.bridgeCount??1))===1){const r=[];let c=0;const g=(b=!1)=>{if(!n)return;const k=typeof performance<"u"?performance.now():Date.now();if(!b&&k-c<80)return;c=k;const I=G(r,a,f,t.stagingId,t.destinationId,o);n(I,l)};for(const b of j){if(t.settings.bridgeFromStaging&&b.id!==t.stagingId||t.settings.excludeZarzakh&&b.id===301e5||t.settings.blacklistEnabled&&o.has(b.id)||T(b))continue;const k=s.get(b.id);if(k==null)continue;let I=null;for(const M of h){const R=b.x-M.x,D=b.y-M.y,O=b.z-M.z,q=R*R+D*D+O*O;if(q>d)continue;const A=Math.sqrt(q);(!I||M.jumps<I.jumps||M.jumps===I.jumps&&A<I.bridgeMeters)&&(I={id:M.id,jumps:M.jumps,bridgeMeters:A})}if(!I)continue;const C=k+I.jumps,$={parkingId:b.id,endpointId:I.id,stagingJumps:k,destinationJumps:I.jumps,bridgeMeters:I.bridgeMeters,totalJumps:C};H(r,$,J,ot)&&g(r.length===1)}if(r.length===0)return{routes:[],message:"No reachable parking systems found.",baselineJumps:l};const N=G(r,a,f,t.stagingId,t.destinationId,o);return N.length===0?{routes:[],message:"No routes found.",baselineJumps:l}:{routes:N,message:null,baselineJumps:l}}const E=new Map,x=[];for(const r of j){if(t.settings.excludeZarzakh&&r.id===301e5||t.settings.blacklistEnabled&&o.has(r.id)||T(r))continue;let c=null;for(const g of h){const N=r.x-g.x,b=r.y-g.y,k=r.z-g.z,I=N*N+b*b+k*k;if(I>d)continue;const C=Math.sqrt(I);(!c||g.jumps<c.jumps||g.jumps===c.jumps&&C<c.bridgeMeters)&&(c={id:g.id,jumps:g.jumps,bridgeMeters:C})}c&&(E.set(r.id,{endpointId:c.id,destinationJumps:c.jumps,bridgeMeters:c.bridgeMeters}),x.push({parkingId:r.id,endpointId:c.id,baseCost:c.jumps}))}if(x.length===0)return{routes:[],message:"No reachable second-bridge parking systems found.",baselineJumps:l};const{dist:w,prev:F,sourceParking:K,sourceEndpoint:at}=dt(x,t.settings),Z=[];for(const r of j){const c=w.get(r.id);c!=null&&(t.settings.bridgeContinuous&&K.get(r.id)!==r.id||t.settings.blacklistEnabled&&o.has(r.id)||Z.push({id:r.id,x:r.x,y:r.y,z:r.z,cost:c}))}if(Z.length===0)return{routes:[],message:"No reachable bridge endpoints found.",baselineJumps:l};const B=[];let Q=0;const gt=(r=!1)=>{if(!n)return;const c=typeof performance<"u"?performance.now():Date.now();if(!r&&c-Q<80)return;Q=c;const g=X(B,a,f,F,t.stagingId,t.destinationId,o);n(g,l)};for(const r of j){if(t.settings.bridgeFromStaging&&r.id!==t.stagingId||t.settings.excludeZarzakh&&r.id===301e5||t.settings.blacklistEnabled&&o.has(r.id)||T(r))continue;const c=s.get(r.id);if(c==null)continue;let g=null;for(const M of Z){const R=r.x-M.x,D=r.y-M.y,O=r.z-M.z,q=R*R+D*D+O*O;if(q>d)continue;const A=Math.sqrt(q),tt=c+M.cost;(!g||tt<c+g.cost||tt===c+g.cost&&A<g.bridgeMeters)&&(g={id:M.id,cost:M.cost,bridgeMeters:A})}if(!g)continue;const N=K.get(g.id),b=at.get(g.id);if(N==null||b==null)continue;const k=E.get(N);if(!k)continue;const I=Math.max(0,g.cost-k.destinationJumps),C=c+g.cost,$={parkingId:r.id,endpointId:g.id,parking2Id:N,endpoint2Id:b,stagingJumps:c,midTravelJumps:I,destinationJumps:k.destinationJumps,bridgeMeters:g.bridgeMeters,bridge2Meters:k.bridgeMeters,totalJumps:C};H(B,$,J,rt)&&gt(B.length===1)}if(B.length===0)return{routes:[],message:"No reachable two-bridge routes found.",baselineJumps:l};const W=X(B,a,f,F,t.stagingId,t.destinationId,o);return W.length===0?{routes:[],message:"No routes found.",baselineJumps:l}:{routes:W,message:null,baselineJumps:l}}self.onmessage=t=>{const n=t.data;if(n.type==="init"){z=n.graph,et(n.graph);return}if(n.type==="compute"){const u=ct(n,(e,i)=>{self.postMessage({type:"partial",requestId:n.requestId,routes:e,message:null,baselineJumps:i})});self.postMessage({type:"result",requestId:n.requestId,...u})}}})();
