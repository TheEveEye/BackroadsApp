var at=Object.defineProperty;var gt=(z,N,C)=>N in z?at(z,N,{enumerable:!0,configurable:!0,writable:!0,value:C}):z[N]=C;var K=(z,N,C)=>gt(z,typeof N!="symbol"?N+"":N,C);(function(){"use strict";let S=null,j=[];function T(t){const e=typeof t.security=="number"?t.security:null;return t.regionId===10000070||e!=null&&e>=.5}function Q(t){const e=[];for(const[r,n]of Object.entries(t.systems)){const s=Number(r);Number.isFinite(s)&&e.push({id:s,x:n.position.x,y:n.position.y,z:n.position.z,regionId:n.regionId,security:Number.isFinite(n.security)?Number(n.security):null,adjacentSystems:n.adjacentSystems||[]})}j=e}function U(t){var r;const e=new Map;if(t.allowAnsiblex&&((r=t.ansiblexes)!=null&&r.length))for(const n of t.ansiblexes){if(!n||n.enabled===!1)continue;const s=Number(n.from),d=Number(n.to);!Number.isFinite(s)||!Number.isFinite(d)||(e.has(s)||e.set(s,[]),e.get(s).push(d),n.bidirectional!==!1&&(e.has(d)||e.set(d,[]),e.get(d).push(s)))}return e}function Z(t,e,r){const n=new Map,s=new Map;if(!S)return{dist:n,prev:s};const d=S.systems,a=d[String(t)];if(!a)return{dist:n,prev:s};const i=new Set;e.excludeZarzakh&&i.add(301e5);const u=!!e.sameRegionOnly,f=a.regionId,l=U(e);n.set(t,0);const p=[t];for(let k=0;k<p.length;k++){const m=p[k],w=n.get(m);if(w==null||w>=r)continue;const y=d[String(m)];if(y&&!i.has(m)&&!(u&&y.regionId!==f)){for(const M of y.adjacentSystems){if(i.has(M))continue;const x=d[String(M)];x&&(u&&x.regionId!==f||n.has(M)||(n.set(M,w+1),s.set(M,m),p.push(M)))}if(e.allowAnsiblex){const M=l.get(m)||[];for(const x of M){if(i.has(x))continue;const E=d[String(x)];E&&(u&&E.regionId!==f||n.has(x)||(n.set(x,w+1),s.set(x,m),p.push(x)))}}}}return{dist:n,prev:s}}function q(t,e,r){const n=[];let s=r;for(;s!=null&&(n.push(s),s!==e);)if(s=t.get(s),s==null)return null;return n.reverse()}class W{constructor(){K(this,"data",[])}push(e){this.data.push(e),this.bubbleUp(this.data.length-1)}pop(){if(this.data.length===0)return;const e=this.data[0],r=this.data.pop();return this.data.length>0&&(this.data[0]=r,this.bubbleDown(0)),e}get size(){return this.data.length}bubbleUp(e){for(;e>0;){const r=Math.floor((e-1)/2);if(this.data[r].cost<=this.data[e].cost)break;[this.data[r],this.data[e]]=[this.data[e],this.data[r]],e=r}}bubbleDown(e){const r=this.data.length;for(;;){let n=e;const s=e*2+1,d=e*2+2;if(s<r&&this.data[s].cost<this.data[n].cost&&(n=s),d<r&&this.data[d].cost<this.data[n].cost&&(n=d),n===e)break;[this.data[n],this.data[e]]=[this.data[e],this.data[n]],e=n}}}function tt(t,e,r){const n=[];let s=e;for(;s!=null&&(n.push(s),s!==r);)if(s=t.get(s),s==null)return null;return n}function et(t,e){return t.totalJumps!==e.totalJumps?t.totalJumps-e.totalJumps:t.stagingJumps!==e.stagingJumps?t.stagingJumps-e.stagingJumps:t.destinationJumps!==e.destinationJumps?t.destinationJumps-e.destinationJumps:t.bridgeMeters-e.bridgeMeters}function nt(t,e){return t.totalJumps!==e.totalJumps?t.totalJumps-e.totalJumps:t.stagingJumps!==e.stagingJumps?t.stagingJumps-e.stagingJumps:t.midTravelJumps!==e.midTravelJumps?t.midTravelJumps-e.midTravelJumps:t.destinationJumps!==e.destinationJumps?t.destinationJumps-e.destinationJumps:t.bridgeMeters!==e.bridgeMeters?t.bridgeMeters-e.bridgeMeters:t.bridge2Meters-e.bridge2Meters}function $(t,e,r,n){const s=t.findIndex(d=>n(e,d)<0);return s===-1?t.length<r?(t.push(e),!0):!1:(t.splice(s,0,e),t.length>r&&t.pop(),!0)}function V(t,e,r,n,s){const d=[];for(const a of t){const i=q(e,n,a.parkingId),u=q(r,s,a.endpointId);!i||!u||d.push({key:`${a.parkingId}-${a.endpointId}`,travelPath:i,postBridgePath:u.slice().reverse(),parkingId:a.parkingId,bridgeEndpointId:a.endpointId,travelJumps:a.stagingJumps,postBridgeJumps:a.destinationJumps,totalJumps:a.totalJumps,bridgeLy:a.bridgeMeters/94607e11})}return d}function Y(t,e,r,n,s,d){const a=[];for(const i of t){const u=q(e,s,i.parkingId),f=tt(n,i.endpointId,i.parking2Id),l=q(r,d,i.endpoint2Id);!u||!f||!l||a.push({key:`${i.parkingId}-${i.endpointId}-${i.parking2Id}-${i.endpoint2Id}`,travelPath:u,midTravelPath:f,postBridgePath:l.slice().reverse(),parkingId:i.parkingId,bridgeEndpointId:i.endpointId,parking2Id:i.parking2Id,bridgeEndpoint2Id:i.endpoint2Id,travelJumps:i.stagingJumps,midTravelJumps:i.midTravelJumps,postBridgeJumps:i.destinationJumps,totalJumps:i.totalJumps,bridgeLy:i.bridgeMeters/94607e11,bridge2Ly:i.bridge2Meters/94607e11})}return a}function st(t){if(!S)return new Map;const e=U(t),r=S.systems,n=new Map,s=!!t.sameRegionOnly;for(const[d,a]of Object.entries(r)){const i=Number(d);if(!Number.isFinite(i)||t.excludeZarzakh&&i===301e5)continue;const u=[];for(const f of a.adjacentSystems||[]){if(t.excludeZarzakh&&f===301e5)continue;const l=r[String(f)];l&&(s&&l.regionId!==a.regionId||u.push(f))}if(t.allowAnsiblex){const f=e.get(i)||[];for(const l of f){if(t.excludeZarzakh&&l===301e5)continue;const p=r[String(l)];p&&(s&&p.regionId!==a.regionId||u.push(l))}}n.set(i,u)}return n}function it(t,e){const r=st(e),n=new Map,s=new Map,d=new Map,a=new Map,i=new W;for(const u of t){const f=n.get(u.parkingId);f!=null&&f<=u.baseCost||(n.set(u.parkingId,u.baseCost),d.set(u.parkingId,u.parkingId),a.set(u.parkingId,u.endpointId),i.push({id:u.parkingId,cost:u.baseCost}))}for(;i.size>0;){const u=i.pop();if(!u)break;const f=n.get(u.id);if(f==null||u.cost!==f)continue;const l=r.get(u.id)||[],p=d.get(u.id),k=a.get(u.id);if(!(p==null||k==null))for(const m of l){const w=f+1,y=n.get(m);(y==null||w<y||w===y&&(d.get(m)==null||p<d.get(m)))&&(n.set(m,w),s.set(m,u.id),d.set(m,p),a.set(m,k),i.push({id:m,cost:w}))}}return{dist:n,prev:s,sourceParking:d,sourceEndpoint:a}}function ot(t,e){if(!S)return{routes:[],message:"Graph not loaded.",baselineJumps:null};const r=S.systems,n=r[String(t.destinationId)],s=r[String(t.stagingId)];if(!n)return{routes:[],message:"Destination system not found.",baselineJumps:null};if(!s)return{routes:[],message:"Staging system not found.",baselineJumps:null};if(T(n))return{routes:[],message:"Destination is in highsec or Pochven.",baselineJumps:null};if(t.settings.bridgeFromStaging&&T(s))return{routes:[],message:"Starting system is in highsec or Pochven.",baselineJumps:null};const d=t.bridgeRange*94607e11,a=d*d,{dist:i,prev:u}=Z(t.stagingId,t.settings,200),{dist:f,prev:l}=Z(t.destinationId,t.settings,200),p=i.get(t.destinationId)??null,k=[];if(t.settings.bridgeIntoDestination){const o=f.get(t.destinationId);o!=null&&k.push({id:t.destinationId,x:n.position.x,y:n.position.y,z:n.position.z,jumps:o})}else for(const o of j){const c=f.get(o.id);c!=null&&k.push({id:o.id,x:o.x,y:o.y,z:o.z,jumps:c})}if(k.length===0)return{routes:[],message:"No destination routes found.",baselineJumps:p};const m=Math.max(1,Math.min(25,t.routesToShow||5));if(Math.max(1,Math.min(2,t.settings.bridgeCount??1))===1){const o=[];let c=0;const g=(b=!1)=>{if(!e)return;const I=typeof performance<"u"?performance.now():Date.now();if(!b&&I-c<80)return;c=I;const h=V(o,u,l,t.stagingId,t.destinationId);e(h,p)};for(const b of j){if(t.settings.bridgeFromStaging&&b.id!==t.stagingId||t.settings.excludeZarzakh&&b.id===301e5||T(b))continue;const I=i.get(b.id);if(I==null)continue;let h=null;for(const J of k){const F=b.x-J.x,R=b.y-J.y,B=b.z-J.z,D=F*F+R*R+B*B;if(D>a)continue;const O=Math.sqrt(D);(!h||J.jumps<h.jumps||J.jumps===h.jumps&&O<h.bridgeMeters)&&(h={id:J.id,jumps:J.jumps,bridgeMeters:O})}if(!h)continue;const P=I+h.jumps,_={parkingId:b.id,endpointId:h.id,stagingJumps:I,destinationJumps:h.jumps,bridgeMeters:h.bridgeMeters,totalJumps:P};$(o,_,m,et)&&g(o.length===1)}if(o.length===0)return{routes:[],message:"No reachable parking systems found.",baselineJumps:p};const v=V(o,u,l,t.stagingId,t.destinationId);return v.length===0?{routes:[],message:"No routes found.",baselineJumps:p}:{routes:v,message:null,baselineJumps:p}}const y=new Map,M=[];for(const o of j){if(t.settings.excludeZarzakh&&o.id===301e5||T(o))continue;let c=null;for(const g of k){const v=o.x-g.x,b=o.y-g.y,I=o.z-g.z,h=v*v+b*b+I*I;if(h>a)continue;const P=Math.sqrt(h);(!c||g.jumps<c.jumps||g.jumps===c.jumps&&P<c.bridgeMeters)&&(c={id:g.id,jumps:g.jumps,bridgeMeters:P})}c&&(y.set(o.id,{endpointId:c.id,destinationJumps:c.jumps,bridgeMeters:c.bridgeMeters}),M.push({parkingId:o.id,endpointId:c.id,baseCost:c.jumps}))}if(M.length===0)return{routes:[],message:"No reachable second-bridge parking systems found.",baselineJumps:p};const{dist:x,prev:E,sourceParking:rt,sourceEndpoint:ut}=it(M,t.settings),A=[];for(const o of j){const c=x.get(o.id);c!=null&&A.push({id:o.id,x:o.x,y:o.y,z:o.z,cost:c})}if(A.length===0)return{routes:[],message:"No reachable bridge endpoints found.",baselineJumps:p};const L=[];let G=0;const dt=(o=!1)=>{if(!e)return;const c=typeof performance<"u"?performance.now():Date.now();if(!o&&c-G<80)return;G=c;const g=Y(L,u,l,E,t.stagingId,t.destinationId);e(g,p)};for(const o of j){if(t.settings.bridgeFromStaging&&o.id!==t.stagingId||t.settings.excludeZarzakh&&o.id===301e5||T(o))continue;const c=i.get(o.id);if(c==null)continue;let g=null;for(const J of A){const F=o.x-J.x,R=o.y-J.y,B=o.z-J.z,D=F*F+R*R+B*B;if(D>a)continue;const O=Math.sqrt(D),X=c+J.cost;(!g||X<c+g.cost||X===c+g.cost&&O<g.bridgeMeters)&&(g={id:J.id,cost:J.cost,bridgeMeters:O})}if(!g)continue;const v=rt.get(g.id),b=ut.get(g.id);if(v==null||b==null)continue;const I=y.get(v);if(!I)continue;const h=Math.max(0,g.cost-I.destinationJumps),P=c+g.cost,_={parkingId:o.id,endpointId:g.id,parking2Id:v,endpoint2Id:b,stagingJumps:c,midTravelJumps:h,destinationJumps:I.destinationJumps,bridgeMeters:g.bridgeMeters,bridge2Meters:I.bridgeMeters,totalJumps:P};$(L,_,m,nt)&&dt(L.length===1)}if(L.length===0)return{routes:[],message:"No reachable two-bridge routes found.",baselineJumps:p};const H=Y(L,u,l,E,t.stagingId,t.destinationId);return H.length===0?{routes:[],message:"No routes found.",baselineJumps:p}:{routes:H,message:null,baselineJumps:p}}self.onmessage=t=>{const e=t.data;if(e.type==="init"){S=e.graph,Q(e.graph);return}if(e.type==="compute"){const r=ot(e,(n,s)=>{self.postMessage({type:"partial",requestId:e.requestId,routes:n,message:null,baselineJumps:s})});self.postMessage({type:"result",requestId:e.requestId,...r})}}})();
